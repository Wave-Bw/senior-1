<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>木桶布局</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    .img-preview {
      width: 1600px;
      margin: 0 auto;
    }

    .img-row {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="img-preview">

  </div>


  <script src="jquery-3.2.1.min.js"></script>
  <script>
    function Barrel($ct){
      this.$ct = $ct
      this.rowList = []
      this.loadImg()
    }

    Barrel.prototype = {
      loadImg: function() {
        var _this = this
        var imgUrls = this.getImgUrls(50);
        $.each(imgUrls,function(idx, url){
          var img = new Image()
          img.src = url
          img.onload = function(){
            var imgInfo = {
              target: $(img),
              width: _this.baseHeight * (img.width/img.height),
              height: _this.baseHeight
            }
            _this.render(imgInfo)
          }
        })
      },
      getImgUrls: function (num) {
        var color, width, height, urls = []
        for(var i=0; i<num; i++) {
          color = Math.random().toString(16).substring(2,8)
          width = Math.floor(Math.random() * 100 + 50)
          height = Math.floor(Math.random() * 30 + 50)
          urls.push("http://placehold.it/" + width + "x" + height + "/" + color + "/fff")
        }
        return urls
      },
      render: function (imgInfo) {
        var clientWidth = this.$ct.width(),
            rowWidth = 0,
            newRowHeight = 0,
            lastImgInfo = imgInfo

        this.rowList.push(imgInfo)
        for(var i=0; i<this.rowList.length; i++){
          rowWidth += this.rowList[i].width
        }
        if(rowWidth > clientWidth){
          this.rowList.pop()
          newRowHeight = clientWidth * 250/rowWidth
          this.layout()
          this.rowList = []
          this.rowList.push(imgInfo)
        }
      },
      layout: function () {
        var $rowCt = $('<div class="img-row"></div>')
        $.each(this.rowList, function (idx,imgInfo) {
          var $imgCt = $('<div class="img-box"></div>'),
              $img = $(imgInfo.target)
          $img.height(rowHeight)
          $imgCt.append($img)
          $rowCt.append($imgCt)
        })
        this.$ct.append($rowCt)
      }
    }


    var barrrr = new Barrel($('.img-preview'))
  </script>
</body>
</html>